<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link type="text/css" rel="stylesheet" href="styles/style.css">
    <link rel="icon" type="image/x-icon" href="images/icon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
    <title>Netherlands Water Stats</title>
</head>
<body>
    <div class="header">
        <svg viewBox="0 20 500 500" preserveAspectRatio="xMinYMin meet">
            <path d="M0,100 C150,200 350,0 500,100 L500,00 L0,0 Z" style="stroke: none; fill:lightskyblue;"></path>
            <text x="77" y="50" fill="white">Netherlands</text>
            <text x="77" y="85" fill="white">Water</text>
            <text x="77" y="120" fill="white">Stats</text>
        </svg>  
    </div>
    <div id="mySidebar" class="navigation">
        <a href="javascript:void(0)" class="closebtn" onclick="closeSidebar()">x</a>
        <div class="text">Drinking Water Pollution</div>
        <div class="bar" id="sidebar-drinking-water-pollution"></div>
        <div class="text">Water Pollution</div>
        <div class="bar" id="sidebar-water-pollution"></div>
        <div class="text">Drinking Water Quality</div>
        <div class="bar" id="sidebar-drinking-water-quality"></div>
        <div class="text">Water Quality</div>
        <div class="bar" id="sidebar-water-quality"></div>
    </div>
    <div id="myNav" class="navigation">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">x</a>
        <div class="text">
            <div>Drinking Water Pollution</div>
            <div>Water Pollution</div>
            <div>Drinking Water Quality</div>
            <div>Water Quality</div>
        </div>
        <div class="bar">
            <div id="nav-drinking-water-pollution"></div>
            <div id="nav-water-pollution"></div>
            <div id="nav-drinking-water-quality"></div>
            <div id="nav-water-quality"></div>
        </div>
    </div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
   integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
   crossorigin="">
    </script>
    <script>
        const wsProtocol = location.protocol.includes('https') ? 'wss:' : 'ws:';
        const socket = new WebSocket(`${wsProtocol}//${location.host}`);

        const sidebar = document.getElementById("mySidebar");
        const sideDrinkingWaterPollution = document.getElementById("sidebar-drinking-water-pollution");
        const sideWaterPollution = document.getElementById("sidebar-water-pollution");
        const sideDrinkingWaterQuality = document.getElementById("sidebar-drinking-water-quality");
        const sideWaterQuality = document.getElementById("sidebar-water-quality");

        const bottomNav = document.getElementById("myNav");
        const navDrinkingWaterPollution = document.getElementById("nav-drinking-water-pollution");
        const navWaterPollution = document.getElementById("nav-water-pollution");
        const navDrinkingWaterQuality = document.getElementById("nav-drinking-water-quality");
        const navWaterQuality = document.getElementById("nav-water-quality");

        let navOpen = false;
        let sidebarOpen = false;

        socket.onmessage = (message) =>{
            const response = JSON.parse(message.data);
            sideDrinkingWaterPollution.innerText = response[0];
            sideWaterPollution.innerText = response[1];
            sideDrinkingWaterQuality.innerText = response[2];
            sideWaterQuality.innerText = response[3];
            navDrinkingWaterPollution.innerText = response[0];
            navWaterPollution.innerText = response[1];
            navDrinkingWaterQuality.innerText = response[2];
            navWaterQuality.innerText = response[3];
        }

        //check whether ws is in closing state or not
        function isOpen(ws) { 
            return ws.readyState === ws.OPEN 
        }

        function openNav(city) {
            if (!isOpen(socket)) {
                return;
            };
            socket.send(JSON.stringify(city));
            if (window.innerWidth > 1000) {
                sidebar.style.width = "220px";
                sidebar.style.right = "0";
                sidebarOpen = true;
            } else if (window.innerWidth <= 1000) {
                bottomNav.style.height = "170px";
                bottomNav.style.bottom = "0";
                navOpen = true;
            }
        }

        function closeSidebar() {
            sidebar.style.width = "0";
            sidebar.style.right = "-50px";
            sidebarOpen = false;
        }

        function closeNav() {
            bottomNav.style.height = "0";
            bottomNav.style.bottom = "-50px";
            navOpen = false;
        }

        window.addEventListener('resize', () => {
            if (window.matchMedia('(max-width: 1000px)').matches && sidebarOpen) {
                closeSidebar();
            } else if (window.matchMedia('(min-width: 1001px)').matches && navOpen) {
                closeNav()
            }
        });

        // Creating map
        const map = L.map('map', {
            minZoom: 7.5,
            maxZoom: 14
        }).setView([52.23, 4.55],  7.5);
 
        // OSM layer
        const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', 
        { attribution });
        map.addLayer(osm);

        // Icon for city indications
        const alkmaar = L.marker([52.6324, 4.7534]).bindPopup('Alkmaar')
        alkmaar.addTo(map)
        alkmaar.addEventListener("click", () => {openNav('alkmaar')})
        const almere = L.marker([52.3508, 5.2647]).bindPopup('Almere')
        almere.addTo(map)
        almere.addEventListener("click", () => {openNav('almere')})
        const amersfoort = L.marker([52.1561, 5.3878]).bindPopup('Amersfoort')
        amersfoort.addTo(map)
        amersfoort.addEventListener("click", () => {openNav('amersfoort')})

    </script>
</body>
</html>